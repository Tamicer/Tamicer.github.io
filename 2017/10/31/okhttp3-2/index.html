<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Tamic Developer Blog">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          OkHttp 3.x 源码解析之Dispather分发器 - Tamic Developer&quot;s Blog | &quot;博客&quot;
        
    </title>

    <link rel="canonical" href="http://tamicer.com/2017/10/31/okhttp3-2/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Tamic</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archives/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://tamicer.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/img/home-bg.jpg')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                          <a class="tag" href="/tags/#Okhttp" title="Okhttp">Okhttp</a>
                        
                          <a class="tag" href="/tags/#架构" title="架构">架构</a>
                        
                    </div>
                    <h1>OkHttp 3.x 源码解析之Dispather分发器</h1>
                    <h2 class="subheading">Okhttp</h2>
                    <span class="meta">
                        Posted by Tamic on
                        2017-10-31
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <blockquote>
<p>tamic: /   www.tamicer.com, 公众号：开发者技术前线</p>
</blockquote>
<h1 id="Dispather概念"><a href="#Dispather概念" class="headerlink" title="Dispather概念"></a>Dispather概念</h1><p>Dispatcher中文是分发器的意思，和拦截器不同的是分发器不做Aaction事件处理。只做事件流向。在Okhttp中Dispatcher负责将每一次Requst进行分发，压栈到自己的线程池，并通过调用者不同的方式进行异步和同步处理！<br>流程来向<br>接着上一章节我提到的拦截器概念，就说明了okhttp每一次发起请求之前先进性Resqust构造，通过OkhttpClent进行构造真实的调用对象Call，接着调用执行者 Call 调用<br>enqueue（）发起请求，下面再重复上一次代码！看着代码自己体会！</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">  Request request =</div><div class="line">            <span class="keyword">new</span> Request.Builder()</div><div class="line">                    .get()</div><div class="line">                    .url(baseUrl)</div><div class="line">                    .build();</div><div class="line">   <span class="comment">//Client</span></div><div class="line">    OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line">   <span class="comment">//创建的是一个RealCall对象</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">Call</span> <span class="keyword">call</span> = client.newCall(request);</div><div class="line"></div><div class="line">  <span class="comment">//异步调用</span></div><div class="line">    <span class="keyword">call</span>.enqueue(<span class="keyword">new</span> Callback() &#123;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> onFailure(<span class="keyword">Call</span> <span class="keyword">call</span>, IOException e) &#123;</div><div class="line"></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        @Override</div><div class="line">        <span class="keyword">public</span> <span class="keyword">void</span> onResponse(<span class="keyword">Call</span> <span class="keyword">call</span>, Response response) <span class="keyword">throws</span> IOException &#123;</div><div class="line">            Log.d(<span class="string">"tamic"</span>, response.body().string());</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么这个<code>Dispatcher</code>和我们的以上说的这几个类<code>Request</code> ，<code>OkHttpClient</code>，<code>Call</code>有毛关系？别急…..听我讲完   ,goto!!!!<br>我们通过主动 <code>New</code>的<code>OkHttpClient</code>的实例构造出一个<code>Call</code>，而这个call通过自己的实现类，调用<code>call.enqueue（）</code>进行发起调用，就是这么一个call中实际上就包含了一个ClientY引用，而这个引用包含一个<br><code>Dispatcher</code>成员变量，好了这个时候你已经明白了这东西怎么和<code>ohttpclient</code>勾搭上了！</p>
<figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">        </div><div class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RealCall</span> <span class="keyword">implements</span> <span class="title">Call</span> </span>&#123;</div><div class="line"><span class="keyword">final</span> OkHttpClient <span class="keyword">client</span>;</div><div class="line"> <span class="keyword">final</span> Request originalRequest;</div><div class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> forWebSocket;</div><div class="line"></div><div class="line"><span class="comment">// Guarded by this.</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> executed;</div><div class="line"></div><div class="line">RealCall(OkHttpClient <span class="keyword">client</span>, Request originalRequest, <span class="keyword">boolean</span> forWebSocket) &#123;</div><div class="line">  <span class="keyword">final</span> EventListener.Factory eventListenerFactory = <span class="keyword">client</span>.eventListenerFactory();</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.<span class="keyword">client</span> = <span class="keyword">client</span>;</div><div class="line">     <span class="comment">//....</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override <span class="keyword">public</span> Request request() &#123;</div><div class="line">  <span class="keyword">return</span> originalRequest;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">@Override <span class="keyword">public</span> <span class="keyword">void</span> enqueue(Callback responseCallback) &#123;</div><div class="line">  synchronized (<span class="keyword">this</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (executed) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already Executed"</span>);</div><div class="line">    executed = <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">  captureCallStackTrace();</div><div class="line">  <span class="comment">// so! 看这里，这里通过你自己的构造的client，继续传给Call，而call的实现类RealCall则保持了这个dispather.</span></div><div class="line">  <span class="keyword">client</span>.dispatcher().enqueue(<span class="keyword">new</span> AsyncCall(responseCallback));<span class="comment">//AsyncCall实际上就是线程的子类</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>概念说了，代码上了，那么来个图，可好？</p>
<p><img src="http://img.blog.csdn.net/20171114201501114?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvc2s3MTk4ODc5MTY=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="okhttp-dispather"></p>
<p>上面解释完，dispather走向的流程，下面就来看看这个Dispatcher的工作原理</p>
<h1 id="Dispather原理"><a href="#Dispather原理" class="headerlink" title="Dispather原理"></a>Dispather原理</h1><p>Dispatcher内部维护者一套线程队列，包含三大点，一个等待线程队列（readyAsyncCalls）<br>，一个正在运行的同步队列（runningAsyncCalls ），正在运行的异步队列（runningSyncCalls），当然有现成必须有一个池的概念<br>ExecutorService就是这里的一个管家角色，在具体了解之前，不妨先看看源码。</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> Dispatcher &#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> maxRequests = <span class="number">64</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">int</span> maxRequestsPerHost = <span class="number">5</span>;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">@Nullable</span> Runnable idleCallback;</div><div class="line"></div><div class="line">  <span class="comment">/** Executes calls. Created lazily. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">@Nullable</span> ExecutorService executorService;</div><div class="line"></div><div class="line">  <span class="comment">/** Ready async calls in the order they'll be run. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; readyAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/** Running asynchronous calls. Includes canceled calls that haven't finished yet. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;AsyncCall&gt; runningAsyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/** Running synchronous calls. Includes canceled calls that haven't finished yet. */</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Deque&lt;RealCall&gt; runningSyncCalls = <span class="keyword">new</span> ArrayDeque&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="keyword">public</span> Dispatcher(ExecutorService executorService) &#123;</div><div class="line">    <span class="keyword">this</span>.executorService = executorService;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>最大请求数支持64个。最大的预备主机支持5个。并且Dispatcher 已被Google小姐姐设置为Final的，就是让大家不要篡改这个调度机制。继续看看提供了那些方法；</p>
<h2 id="一-入队"><a href="#一-入队" class="headerlink" title="一 入队"></a>一 入队</h2><p>上面提到当调用 call.enqueue（）的时候，Reall这个调用者会调用:<br> client.dispatcher().enqueue(new AsyncCall(responseCallback)) 这个函数，那么这里你也猜到我就瞎编神马了，好，就来大话下这个<br>enqueue（）！ 上源码：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">synchronized</span> <span class="keyword">void</span> enqueue(AsyncCall <span class="keyword">call</span>) &#123;</div><div class="line">  <span class="keyword">if</span> (runningAsyncCalls.<span class="keyword">size</span>() &lt; maxRequests &amp;&amp; runningCallsForHost(<span class="keyword">call</span>) &lt; maxRequestsPerHost) &#123;</div><div class="line">    runningAsyncCalls.add(<span class="keyword">call</span>);</div><div class="line">    executorService().execute(<span class="keyword">call</span>);</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    readyAsyncCalls.add(<span class="keyword">call</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>明白？一个同步锁决定了Dispatcher 全局只有一个并支持同步了，因为我们调用了异步则要保证这段代码必须要被锁定执行，回调到对应callBack中。纳尼？异步调用怎么到了分发器就是同步了？<br>你tm这就就骗我们小学生，好好 我给你看个东西。接下来我让你明白这玩意好好不用<br>上面的方法将我们生产的Reall产生的线程add（）到执行队列中，并通过我们的管理器<code>ExecutorService</code> 执行这个<code>runnbale</code>, 玩过多线程同学突然明白了，咋就这么简单了，这样的线程池我分分钟给你干几个，但是我真没想能这么用。</p>
<p> executorService()方法如下:不需要多说明。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="function">ExecutorService <span class="title">executorService</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (executorService == <span class="keyword">null</span>) &#123;</div><div class="line">    executorService = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60</span>, TimeUnit.SECONDS,</div><div class="line">        <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;(), Util.threadFactory(<span class="string">"OkHttp Dispatcher"</span>, <span class="keyword">false</span>));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> executorService;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="二-出队："><a href="#二-出队：" class="headerlink" title="二 出队："></a>二 出队：</h2><p>有add肯定有remove函数，接着看看cannel函数，然而你要明白dipath的取消并不是由他自己完成，而是交给了拦截器（<br> RetryAndFollowUpInterceptor）处理，对于发出去的请求无论等待还是以只执行完成，都需要进过拦截器处理，那么拦截器将会标记，如果为取消，则中断callback流程，<br>代码如下：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">  canceled = <span class="keyword">true</span>;</div><div class="line"> StreamAllocation streamAllocation = <span class="keyword">this</span>.streamAllocation;</div><div class="line"> <span class="keyword">if</span> (streamAllocation != <span class="keyword">null</span>) streamAllocation.cancel();<span class="comment">//这里不再具追究，内部则调用coneation.canel()将连接中断</span></div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面有一点还未解释，<br>为什么call.cancel()取消为什么会调用拦截器的cancel()?</p>
<p>这是因为<code>Dispatcher</code>的取消函数会调用这个穿进来的Call，而这个call实际上就是我们自己在调用Call.equen()是构造的那个，开发者实际上直接代码中调用call.cancel()的也意味着直接调用第三部的代码。<br>AsyncCall线程，而这个 call.get()的则是返回一个我们开头介绍的call这个调用对象，cancel()的内部实现如下：</p>
<p>###第一步:Dispatcher。cancelAll() </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> cancelAll() &#123;</div><div class="line">  <span class="keyword">for</span> (AsyncCall <span class="keyword">call</span> : readyAsyncCalls) &#123;</div><div class="line">    <span class="keyword">call</span>.get().cancel();</div><div class="line"> &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (AsyncCall <span class="keyword">call</span> : runningAsyncCalls) &#123;</div><div class="line">    <span class="keyword">call</span>.get().cancel();</div><div class="line"> &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (RealCall <span class="keyword">call</span> : runningSyncCalls) &#123;</div><div class="line">    <span class="keyword">call</span>.cancel();</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>###第二步：AsyncCall.cancel()</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">RealCall <span class="keyword">get</span>() &#123;</div><div class="line">  <span class="keyword">return</span> RealCall.<span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="第三步：RealCall-cancel"><a href="#第三步：RealCall-cancel" class="headerlink" title="第三步：RealCall.cancel()"></a>第三步：RealCall.cancel()</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span> <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">  retryAndFollowUpInterceptor.cancel();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##三 结束<br>既然一个线程池队列能提供add和remove肯定也会提供线程执行完毕的方法，Dispatcher则提供了<br>finished（）,代码如下：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> &lt;T&gt; <span class="keyword">void</span> finished(Deque&lt;T&gt; calls, T <span class="keyword">call</span>, <span class="keyword">boolean</span> promoteCalls) &#123;</div><div class="line">  <span class="keyword">int</span> runningCallsCount;</div><div class="line"> Runnable idleCallback;</div><div class="line"> <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (!calls.remove(<span class="keyword">call</span>)) <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Call wasn't in-flight!"</span>);</div><div class="line"> <span class="keyword">if</span> (promoteCalls) promoteCalls();<span class="comment">//监测内部是否有空线程，执行的大于max限制等</span></div><div class="line"> runningCallsCount = runningCallsCount();</div><div class="line"> idleCallback = <span class="keyword">this</span>.idleCallback;</div><div class="line"> &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (runningCallsCount == <span class="number">0</span> &amp;&amp; idleCallback != <span class="keyword">null</span>) &#123;</div><div class="line">    idleCallback.run();</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好了 ，该到总结的时候了，<code>Dippather</code>实际上没开发者认为的这么神秘<br>他持有这一个可生产线程池的service和三个可代表的线程维护的队列，并提供了add，remove，cancel三个性质的方法，而只不过这个取消的方法交给了拦截器处理，拦截器调用Conection接口进行传输层的握手中断。并执行callBack的取消接口提供给上层。<br>拦截器和<code>Conection</code>见上一章的介绍。</p>
<h1 id="疑问："><a href="#疑问：" class="headerlink" title="疑问："></a>疑问：</h1><p><strong>1 为什么dispather没提供怎么请求的功能</strong><br> <strong>2 为什么dispather不进行缓存处理？ </strong></p>
<p>dipathper里面持有的线程，则进行自己的请求处理，不受<code>dipathper</code>管控，实际上就是线程自己在执行。<br>自己的<code>execute()</code>方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@Override</span> <span class="keyword">protected</span> void execute() &#123;</div><div class="line">    boolean signalledCallback = <span class="literal">false</span>;</div><div class="line"> <span class="keyword">try</span> &#123;</div><div class="line">      Response response = getResponseWithInterceptorChain();</div><div class="line"> <span class="keyword">if</span> (retryAndFollowUpInterceptor.isCanceled()) &#123;</div><div class="line">        signalledCallback = <span class="literal">true</span>;</div><div class="line"> responseCallback.onFailure(RealCall.<span class="keyword">this</span>, new IOException(<span class="string">"Canceled"</span>));</div><div class="line"> &#125; <span class="keyword">else</span> &#123;</div><div class="line">        signalledCallback = <span class="literal">true</span>;</div><div class="line"> responseCallback.onResponse(RealCall.<span class="keyword">this</span>, response);</div><div class="line"> &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      <span class="keyword">if</span> (signalledCallback) &#123;</div><div class="line">        <span class="comment">// Do not signal the callback twice!</span></div><div class="line"> Platform.<span class="keyword">get</span>().log(INFO, <span class="string">"Callback failure for "</span> + toLoggableString(), e);</div><div class="line"> &#125; <span class="keyword">else</span> &#123;</div><div class="line">        responseCallback.onFailure(RealCall.<span class="keyword">this</span>, e);</div><div class="line"> &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">      client.dispatcher().finished(<span class="keyword">this</span>);</div><div class="line"> &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第二个问题，等我们学完第三篇 okhttp的缓存<code>Cache</code>，自然迎刃而解。</p>
<blockquote>
<p>Tamic原创，更多其他关注微信公众号 开发者技术前线。</p>
</blockquote>


                <hr>

                

                
                <!-- 多说 Share start -->
                </style>
                <div class="ds-share"
                    style="text-align: right"
                    data-thread-key="2017/10/31/okhttp3-2/"
                    data-title="OkHttp 3.x 源码解析之Dispather分发器"
                    data-url="http://tamicer.com/2017/10/31/okhttp3-2/"
                    data-images=""
                    data-content="
tamic: /   www.tamicer.com, 公众号：开发者技术前线

Dispa... | Tamic Developer&quot;s Blog | &quot;博客&quot; " >
                    <div class="ds-share-inline">
                      <ul  class="ds-share-icons-16">
                        <li data-toggle="ds-share-icons-more"><a class="ds-more" href="#">分享到：</a></li>
                        <li><a class="ds-wechat flat" href="javascript:void(0);" data-service="wechat">微信</a></li>
                        <li><a class="ds-weibo flat" href="javascript:void(0);" data-service="weibo">微博</a></li>
                        <li><a class="ds-douban flat" href="javascript:void(0);" data-service="douban">豆瓣</a></li>
                      </ul>
                      <div class="ds-share-icons-more">
                      </div>
                    </div>
                <hr>


                </div>

                <!-- 多说 Share end-->
                

                <ul class="pager">
                    
                    
                        <li class="next">
                            <a href="/2017/07/15/Okhttp2_2017/" data-toggle="tooltip" data-placement="top" title="OkHttp 3.x 源码解析之Interceptor 拦截器">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                
                <!-- 多说评论框 start -->
                <div class="comment">
                    <div class="ds-thread"
                        data-thread-key="2017/10/31/okhttp3-2/"
                        data-title="OkHttp 3.x 源码解析之Dispather分发器"
                        data-url="http://tamicer.com/2017/10/31/okhttp3-2/" >
                    </div>
                </div>
                <!-- 多说评论框 end -->
                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>
    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Android" title="Android">Android</a>
                        
                          <a class="tag" href="/tags/#Okhttp" title="Okhttp">Okhttp</a>
                        
                          <a class="tag" href="/tags/#架构" title="架构">架构</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="http://www.jianshu.com/u/3bbb1ddf4fd5" target="_blank">Tamic&#39;s Blog</a></li>
                    
                        <li><a href="https://github.com/Tamicer" target="_blank">Tamic github</a></li>
                    
                        <li><a href="#" target="_blank">Foo</a></li>
                    
                        <li><a href="#" target="_blank">Bar</a></li>
                    
                        <li><a href="#" target="_blank">Example Friends</a></li>
                    
                        <li><a href="#" target="_blank">It helps SEO</a></li>
                    
                </ul>
                
            </div>

        </div>
    </div>
</article>


<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    // dynamic User by Hux
    var _user = 'tamicer';

    // duoshuo comment query.
    var duoshuoQuery = {short_name: _user };
    (function() {
        var ds = document.createElement('script');
        ds.type = 'text/javascript';ds.async = true;
        ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
        ds.charset = 'UTF-8';
        (document.getElementsByTagName('head')[0]
         || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
</script>
<!-- 多说公共JS代码 end -->



<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "hexo-theme-huxblog";
    var disqus_identifier = "http://tamicer.com/2017/10/31/okhttp3-2/";
    var disqus_url = "http://tamicer.com/2017/10/31/okhttp3-2/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/Tamic">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://blog.csdn.net//sk719887916">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-csdn fa-stack-1x fa-inverse">C</i>
                            </span>
                        </a>
                    </li>
                



                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/xing-qiu-ren-50">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/TamicDeveloper">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/Tamic">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://github.com/Tamicer">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/Tamic">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="http://www.jianshu.com/u/3bbb1ddf4fd5">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-jianshu fa-stack-1x fa-inverse">简</i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Tamic 2017 
                    <br>
                    Theme by <a href="http://Tamicer.com">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a href="http://Tamicer.com">Tamic</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=Tamicer&repo=Novate&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://tamicer.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'tamicer.com';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>





<!-- Image to hack wechat -->
<img src="http://tamicer.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
